<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MDG Material Form (TABLE 1 + Rules)</title>
<style>
:root { --sap-bg:#f5f7f9; --sap-surface:#fff; --sap-primary:#0a6ed1; --sap-border:#d7dce2; --text:#222; --muted:#69707a; }
* { box-sizing: border-box; } body { margin:0; background:var(--sap-bg); color:var(--text); font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; }
.app { max-width:1200px; margin:24px auto; padding:24px; background:var(--sap-surface); border:1px solid var(--sap-border); border-radius:16px; }
h1 { margin:0 0 12px 0; font-size:22px; } .muted { color:var(--muted); font-size:13px; }
.row { display:flex; gap:16px; flex-wrap:wrap; margin-top:12px; }
.card { flex:1 1 360px; border:1px solid var(--sap-border); border-radius:14px; padding:16px; background:#fff; min-width:320px; }
.label { display:block; font-weight:600; margin-bottom:6px; font-size:13px; }
.input, select { width:100%; padding:10px 12px; border:1px solid var(--sap-border); border-radius:10px; background:#fff; }
.btn { background:var(--sap-primary); color:#fff; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; }
.btn:disabled { opacity:.5; cursor:not-allowed; }
.kv { display:grid; grid-template-columns: 170px 1fr; gap:8px; font-size:14px; }
.badge { display:inline-block; background:#eef5ff; color:#094b9b; padding:2px 8px; border-radius:20px; font-size:12px; margin-left:6px; }
.char-row { display:grid; grid-template-columns: 220px 1fr; gap:12px; align-items:center; padding:8px 0; border-bottom:1px dashed var(--sap-border); }
.char-row:last-child { border-bottom:none; }
.desc { color:var(--muted); font-size:12px; }
.rulepill { display:inline-block; font-size:11px; color:#334; background:#f1f5fb; border:1px solid #d7e3f8; border-radius:999px; padding:2px 6px; margin-left:6px; }
</style>
</head>
<body>
<div class="app">
  <h1>MDG Material Form</h1>
  <div class="muted">Hanya Class dari <strong>TABLE 1</strong>. Aturan Case/Prefix/Suffix/Without Space diterapkan saat Generate.</div>

  <div class="row">
    <div class="card" style="max-width:460px">
      <label class="label">Class</label>
      <input class="input" id="classInput" list="classList" placeholder="Ketik untuk mencari class…"/>
      <datalist id="classList"></datalist>
      <div class="desc" id="classMeta"></div>
    </div>

    <!-- Company selection removed as per new requirement -->

    <div class="card" style="max-width:340px">
      <label class="label">Server Reference</label>
      <select class="input" id="server">
        <option value="">Pilih server…</option>
        <option value="SPR">SPR</option>
        <option value="SPE">SPE</option>
        <option value="TPR">TPR</option>
        <option value="APE">APE</option>
      </select>
      <label class="label" style="margin-top:10px">MID Reference</label>
      <input class="input" id="mid" placeholder="mis. 20030"/>
    </div>
  </div>

  <div class="card" id="charCard">
    <div class="label">Characteristics</div>
    <div id="charBox"></div>
  </div>

  <div class="row">
    <button class="btn" id="btnGen">Generate Summary</button>
    <button class="btn" id="btnSubmit">Submit</button>
  </div>

  <div class="card">
    <div class="label">Summary</div>
    <div class="kv">
      <div>Server Reference</div><div id="sumServer">-</div>
      <div>MID Reference</div><div id="sumMID">-</div>
      <!-- Company summary removed per new requirement -->
      <div>Hasil Mat Desc</div><div id="sumMatDesc">-</div>
    </div>
  </div>
</div>

<script>
const LOCAL_JSON_URL = "./data/form_data.json";
const SUBMIT_URL = "https://script.google.com/macros/s/AKfycbzbLZUtvSxjBKOkpEOYgrxoDfXkg1H2K5ug-DTIKGpUH29RgM5-JIhedHqukAPpmWsr/exec";

// Hardcoded object dependency rules derived from ZPI1_Object_Dependency.xlsx
// Each controlling characteristic maps its triggering values to a list of characteristics that should appear and whether they are mandatory
const charDependencies = {
  EMBOSSED_BRAND_WINGS: {
    // Show and require the Wings brand characteristic when the embossed brand flag is YES
    YES: { show: ['BRAND_WINGS_SIPI'], mandatory: ['BRAND_WINGS_SIPI'] }
  },
  EXTERNAL_BRAND: {
    YES: { show: ['BRAND_EXTERNAL','NO_SERI_BRAND_EXTERNAL'], mandatory: ['BRAND_EXTERNAL','NO_SERI_BRAND_EXTERNAL'] }
  },
  HAS_SPESIFIC_COLOUR: {
    YES: { show: ['COLOUR'], mandatory: ['COLOUR'] }
  },
  EMBOSSED_SPESIFIC_DESAIN: {
    YES: { show: ['DESAIN_NAME','DESAIN_MONTH','DESAIN_YEAR'], mandatory: ['DESAIN_NAME','DESAIN_MONTH','DESAIN_YEAR'] }
  },
  SPEC_QTY_IN_ONE_BUNDLE: {
    YES: { show: ['QTY_IN_ONE_BUNDLE'], mandatory: ['QTY_IN_ONE_BUNDLE'] }
  },
  ITEM_SHAPE: {
    PERSEGI: { show: ['LENGTH_PCS','WIDTH_PCS','HEIGHT_PCS','SIZE_UNIT_DIMENSI'], mandatory: ['LENGTH_PCS','WIDTH_PCS','HEIGHT_PCS','SIZE_UNIT_DIMENSI'] },
    BULAT: { show: ['DIAMETER_PCS','HEIGHT_PCS','SIZE_UNIT_DIMENSI'], mandatory: ['DIAMETER_PCS','HEIGHT_PCS','SIZE_UNIT_DIMENSI'] }
  }
};

// Mapping of ACTIVITY_TYPE_ADS to available ACTIVITY_OBJECT_ADS values
const activityObjectMap = {
  'BROAD.': ['RADIO', 'TV', 'CINEMA'],
  'DIG.': ['MEDSOS', 'VID. ONLINE', 'SERCH ADS.'],
  'EVNT SPONSHP': ['KOMUNITS','KULINER','PENDIDIKN','FEST. MUSIK','SPORT','FASHION','LIFESTYLE'],
  'IN-STORE MED': ['DISP. PROMO'],
  'OOH': ['VIDEOTRON','TRNSIT BRAND.','PUBL AREA'],
  'PRINTED': ['BROSUR','POSTER','KATALOG','BANNER','BILLBOARD','KORAN','MAJALAH'],
  'TALLNT ARTIS': ['SHOOTING'],
  'TALLNT BA': ['EVNT ATTEND.','LIVE SHOP. COLLAB'],
  'TALLNT KOL': ['CONT. CREAT.','POSTING','EVNT ATTEND.','LIVE SHOP. COLLAB']
};

// Store references to characteristic rows for dependency handling
let charRows = {};

// Update dependent characteristics visibility based on controlling values
function updateDependencies() {
  // Hide all dependent rows initially and clear mandatory flag
  Object.keys(charRows).forEach((charName) => {
    if (!charRows[charName]) return;
    charRows[charName].style.display = '';
    const inputEl = charRows[charName].querySelector('input');
    if (inputEl) {
      inputEl.required = false;
    }
  });
  // Determine char values
  const values = {};
  for (const [name,row] of Object.entries(charRows)) {
    const inp = row.querySelector('input');
    if (inp) values[name] = inp.value.trim();
  }
  // Apply hide/show rules based on dependencies
  // First hide all dependent rows defined in charDependencies
  const dependentSet = new Set();
  for (const parent in charDependencies) {
    const rules = charDependencies[parent];
    for (const val in rules) {
      (rules[val].show || []).forEach((c) => dependentSet.add(c));
    }
  }
  dependentSet.forEach((c) => {
    if (charRows[c]) {
      charRows[c].style.display = 'none';
      const inputEl = charRows[c].querySelector('input');
      if (inputEl) inputEl.required = false;
    }
  });
  // Apply rules: for each controlling char, check its value
  for (const parent in charDependencies) {
    const parentVal = (values[parent] || '').toUpperCase();
    const rules = charDependencies[parent];
    if (rules[parentVal]) {
      const showList = rules[parentVal].show || [];
      const mandatoryList = rules[parentVal].mandatory || [];
      showList.forEach((child) => {
        if (charRows[child]) {
          charRows[child].style.display = '';
          const inputEl = charRows[child].querySelector('input');
          if (inputEl && mandatoryList.includes(child)) {
            inputEl.required = true;
          }
        }
      });
    }
  }
  // Update ACTIVITY_OBJECT_ADS options based on ACTIVITY_TYPE_ADS value
  if (values['ACTIVITY_TYPE_ADS'] !== undefined && charRows['ACTIVITY_OBJECT_ADS']) {
    const typeVal = values['ACTIVITY_TYPE_ADS'];
    const allowed = activityObjectMap[typeVal] || [];
    const inputObj = charRows['ACTIVITY_OBJECT_ADS'].querySelector('input');
    if (inputObj) {
      // Remove existing datalist if any
      const oldListId = inputObj.getAttribute('list');
      if (oldListId) {
        const oldList = document.getElementById(oldListId);
        if (oldList) oldList.remove();
      }
      // Create new datalist with allowed options if any
      if (allowed.length) {
        const newListId = 'dl_ACTIVITY_OBJECT_ADS_dyn';
        const dl = document.createElement('datalist');
        dl.id = newListId;
        allowed.forEach((val) => {
          const opt = document.createElement('option');
          opt.value = val;
          dl.appendChild(opt);
        });
        // Append new datalist and assign list attribute
        inputObj.setAttribute('list', newListId);
        inputObj.parentElement.appendChild(dl);
      } else {
        inputObj.removeAttribute('list');
      }
    }
  }
}

let DATA = null;

async function loadData() {
  const res = await fetch(LOCAL_JSON_URL, { cache: "no-store" });
  DATA = await res.json();
}

function populateClassList() {
  const dl = document.getElementById('classList');
  dl.innerHTML = "";
  // ONLY classes present in the JSON (already TABLE 1 filtered)
  const classes = Object.keys(DATA.classes).sort();
  for (const c of classes) {
    const opt = document.createElement('option');
    opt.value = c;
    dl.appendChild(opt);
  }
}

function applyCase(str, flag) {
  if (!str) return str;
  switch ((flag||'').toUpperCase()) {
    case 'U': return str.toUpperCase();
    case 'L': return str.toLowerCase();
    case 'P': default:
      // Proper Case (tiap kata kapital awal)
      return str.replace(/\w\S*/g, (w)=> w.charAt(0).toUpperCase() + w.slice(1).toLowerCase());
  }
}

function renderCharacteristicsForClass(clsName) {
  const box = document.getElementById('charBox');
  box.innerHTML = "";
  const rows = (DATA.classes[clsName] || []).slice().sort((a,b)=> (a.sequence||0)-(b.sequence||0));
  for (const item of rows) {
    const charName = item.characteristic || item.char_name || "";
    if (!charName) continue;
    const desc = (DATA.char_desc && DATA.char_desc[charName]) ? DATA.char_desc[charName] : "";
    const attr = (DATA.char_attr && DATA.char_attr[charName]) ? DATA.char_attr[charName] : {};
    const values = (DATA.char_values && DATA.char_values[charName]) ? DATA.char_values[charName] : [];

    const row = document.createElement('div'); row.className = 'char-row';
    const left = document.createElement('div');
    const right = document.createElement('div');

    left.innerHTML = `<div><strong>${charName}</strong>
      ${ item.case ? '<span class="rulepill">Case: '+item.case+'</span>' : '' }
      ${ item.prefix ? '<span class="rulepill">Prefix: '+item.prefix+'</span>' : '' }
      ${ item.suffix ? '<span class="rulepill">Suffix: '+item.suffix+'</span>' : '' }
      ${ (item.without_space||item.withoutSpace)==='Y' ? '<span class="rulepill">No Space</span>' : '' }
      ${ attr.entry_required ? '<span class="badge">Required</span>' : '' }
      ${ attr.additional_values ? '<span class="badge">Free text allowed</span>' : '' }
      </div>
      <div class="desc">${desc || '&nbsp;'} </div>`;

    const input = document.createElement('input');
    input.className = 'input';
    input.placeholder = "Isi nilai karakteristik…";
    input.dataset.charName = charName;
    input.dataset.sequence = String(item.sequence || 0);
    input.dataset.caseFlag = item.case || '';
    input.dataset.prefix = item.prefix || '';
    input.dataset.suffix = item.suffix || '';
    input.dataset.withoutSpace = item.without_space || item.withoutSpace || '';

    // datalist values
    if (values && values.length) {
      const listId = 'dl_'+charName;
      const dl = document.createElement('datalist');
      dl.id = listId;
      for (const v of values) {
        const o = document.createElement('option');
        o.value = v.value;
        dl.appendChild(o);
        if (v.default && !input.value) input.value = v.value;
      }
      input.setAttribute('list', listId);
      right.appendChild(dl);
    }
    right.appendChild(input);

    row.appendChild(left); row.appendChild(right);
    box.appendChild(row);
  }
  // After all rows are created, prepare dependency handling
  // Build a map of characteristic names to their row elements
  charRows = {};
  const allRows = box.querySelectorAll('.char-row');
  allRows.forEach((r) => {
    const inp = r.querySelector('input');
    if (inp && inp.dataset.charName) {
      charRows[inp.dataset.charName] = r;
    }
  });
  // Run initial dependency update to hide/show dependent rows
  if (typeof updateDependencies === 'function') {
    updateDependencies();
  }
  // Ensure change listener is attached once to handle dependency changes
  box.removeEventListener('change', updateDependencies);
  box.addEventListener('change', updateDependencies);
}

function generateSummary() {
  const clsName = document.getElementById('classInput').value.trim();
  const server = document.getElementById('server').value.trim();
  const mid = document.getElementById('mid').value.trim();

  const inputs = Array.from(document.querySelectorAll('#charBox input'));
  const parts = [];
  inputs.sort((a,b)=> parseInt(a.dataset.sequence||'0') - parseInt(b.dataset.sequence||'0'));
  for (const el of inputs) {
    let val = el.value.trim();
    if (!val) continue;
    // apply case
    val = applyCase(val, el.dataset.caseFlag);
    // prefix/suffix
    const pre = el.dataset.prefix || ''; const suf = el.dataset.suffix || '';
    val = (pre ? pre : '') + val + (suf ? suf : '');
    // spacing
    const noSpace = (el.dataset.withoutSpace||'').toUpperCase() === 'Y';
    if (parts.length === 0) {
      parts.push(val);
    } else {
      if (noSpace) {
        // merge to previous part without space
        parts[parts.length-1] = parts[parts.length-1] + val;
      } else {
        parts.push(val);
      }
    }
  }
  const matDesc = parts.join(' ');

  document.getElementById('sumServer').innerText = server || '-';
  document.getElementById('sumMID').innerText = mid || '-';
  document.getElementById('sumMatDesc').innerText = matDesc || '-';

  return { clsName, server, mid, matDesc, values: inputs.map(el => ({name: el.dataset.charName, val: el.value.trim()})) };
}

async function submitPayload() {
  const payload = generateSummary();
  if (!payload.clsName) { alert('Pilih Class yang tersedia (TABLE 1)'); return; }
  if (!DATA.classes[payload.clsName]) { alert('Class tidak terdaftar dalam TABLE 1.'); return; }
  // Ask for MID ECC before submitting
  let midEcc = prompt('Masukkan MID ECC (8 digit angka):');
  if (midEcc === null) {
    // User cancelled input
    return;
  }
  midEcc = (midEcc || '').trim();
  if (!/^\d{8}$/.test(midEcc)) {
    alert('MID ECC harus terdiri dari 8 digit angka.');
    return;
  }
  payload.mid_ecc = midEcc;
  try {
    await fetch(SUBMIT_URL, {
      method: 'POST',
      mode: 'no-cors',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify(Object.assign({ className: payload.clsName }, payload))
    });
    alert('Data dikirim ke Google Sheet (receiver).');
  } catch(e) {
    console.warn('Submit error:', e);
    alert('Gagal mengirim. Coba lagi.');
  }
}

document.addEventListener('DOMContentLoaded', async () => {
  try {
    await loadData();
    populateClassList();
    document.getElementById('classInput').addEventListener('change', (e)=> {
      const v = e.target.value.trim();
      if (!DATA.classes[v]) {
        e.target.value = '';
        document.getElementById('classMeta').innerText = 'Class tidak tersedia (hanya TABLE 1).';
        document.getElementById('charBox').innerHTML = '';
        return;
      } else {
        document.getElementById('classMeta').innerText = '';
      }
      renderCharacteristicsForClass(v);
    });
    document.getElementById('btnGen').addEventListener('click', generateSummary);
    document.getElementById('btnSubmit').addEventListener('click', submitPayload);
  } catch(e) {
    console.error('Init error', e);
    alert('Gagal memuat konfigurasi.');
  }
});
</script>
</body>
</html>
