<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MDG Material Form (TABLE 1 + Rules)</title>
<style>
:root { --sap-bg:#f5f7f9; --sap-surface:#fff; --sap-primary:#0a6ed1; --sap-border:#d7dce2; --text:#222; --muted:#69707a; }
* { box-sizing: border-box; } body { margin:0; background:var(--sap-bg); color:var(--text); font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; }
.app { max-width:1200px; margin:24px auto; padding:24px; background:var(--sap-surface); border:1px solid var(--sap-border); border-radius:16px; }
h1 { margin:0 0 12px 0; font-size:22px; } .muted { color:var(--muted); font-size:13px; }
.row { display:flex; gap:16px; flex-wrap:wrap; margin-top:12px; }
.card { flex:1 1 360px; border:1px solid var(--sap-border); border-radius:14px; padding:16px; background:#fff; min-width:320px; }
.label { display:block; font-weight:600; margin-bottom:6px; font-size:13px; }
.input, select { width:100%; padding:10px 12px; border:1px solid var(--sap-border); border-radius:10px; background:#fff; }
.btn { background:var(--sap-primary); color:#fff; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; }
.btn:disabled { opacity:.5; cursor:not-allowed; }
.kv { display:grid; grid-template-columns: 170px 1fr; gap:8px; font-size:14px; }
.badge { display:inline-block; background:#eef5ff; color:#094b9b; padding:2px 8px; border-radius:20px; font-size:12px; margin-left:6px; }
.char-row { display:grid; grid-template-columns: 220px 1fr; gap:12px; align-items:center; padding:8px 0; border-bottom:1px dashed var(--sap-border); }
.char-row:last-child { border-bottom:none; }
.desc { color:var(--muted); font-size:12px; }
.rulepill { display:inline-block; font-size:11px; color:#334; background:#f1f5fb; border:1px solid #d7e3f8; border-radius:999px; padding:2px 6px; margin-left:6px; }
</style>
</head>
<body>
<div class="app">
  <h1>MDG Material Form</h1>
  <div class="muted">Hanya Class dari <strong>TABLE 1</strong>. Aturan Case/Prefix/Suffix/Without Space diterapkan saat Generate.</div>

  <div class="row">
    <div class="card" style="max-width:460px">
      <label class="label">Class</label>
      <input class="input" id="classInput" list="classList" placeholder="Ketik untuk mencari class…"/>
      <datalist id="classList"></datalist>
      <div class="desc" id="classMeta"></div>
    </div>

    <div class="card" style="max-width:420px">
      <label class="label">Use for Company</label>
      <select class="input" id="company">
        <option value="">Pilih company…</option>
        <option>PT Sayap Mas Utama</option>
        <option>PT Wings Surya</option>
        <option>PT Karunia Alam Segar</option>
        <option>PT Prakarsa Alam Segar</option>
        <option>PT Lion Wings</option>
        <option>PT Glico Wings</option>
        <option>PT Calbee Wings</option>
      </select>
    </div>

    <div class="card" style="max-width:340px">
      <label class="label">Server Reference</label>
      <input class="input" id="server" placeholder="mis. TPR"/>
      <label class="label" style="margin-top:10px">MID Reference</label>
      <input class="input" id="mid" placeholder="mis. 20030"/>
    </div>
  </div>

  <div class="card" id="charCard">
    <div class="label">Characteristics</div>
    <div id="charBox"></div>
  </div>

  <div class="row">
    <button class="btn" id="btnGen">Generate Summary</button>
    <button class="btn" id="btnSubmit">Submit</button>
  </div>

  <div class="card">
    <div class="label">Summary</div>
    <div class="kv">
      <div>Server Reference</div><div id="sumServer">-</div>
      <div>MID Reference</div><div id="sumMID">-</div>
      <div>Company</div><div id="sumCompany">-</div>
      <div>Hasil Mat Desc</div><div id="sumMatDesc">-</div>
    </div>
  </div>
</div>

<script>
const LOCAL_JSON_URL = "./data/form_data.json";
const SUBMIT_URL = "https://script.google.com/macros/s/AKfycbzbLZUtvSxjBKOkpEOYgrxoDfXkg1H2K5ug-DTIKGpUH29RgM5-JIhedHqukAPpmWsr/exec";

let DATA = null;

async function loadData() {
  const res = await fetch(LOCAL_JSON_URL, { cache: "no-store" });
  DATA = await res.json();
}

function populateClassList() {
  const dl = document.getElementById('classList');
  dl.innerHTML = "";
  // ONLY classes present in the JSON (already TABLE 1 filtered)
  const classes = Object.keys(DATA.classes).sort();
  for (const c of classes) {
    const opt = document.createElement('option');
    opt.value = c;
    dl.appendChild(opt);
  }
}

function applyCase(str, flag) {
  if (!str) return str;
  switch ((flag||'').toUpperCase()) {
    case 'U': return str.toUpperCase();
    case 'L': return str.toLowerCase();
    case 'P': default:
      // Proper Case (tiap kata kapital awal)
      return str.replace(/\w\S*/g, (w)=> w.charAt(0).toUpperCase() + w.slice(1).toLowerCase());
  }
}

function renderCharacteristicsForClass(clsName) {
  const box = document.getElementById('charBox');
  box.innerHTML = "";
  const rows = (DATA.classes[clsName] || []).slice().sort((a,b)=> (a.sequence||0)-(b.sequence||0));
  for (const item of rows) {
    const charName = item.characteristic || item.char_name || "";
    if (!charName) continue;
    const desc = (DATA.char_desc && DATA.char_desc[charName]) ? DATA.char_desc[charName] : "";
    const attr = (DATA.char_attr && DATA.char_attr[charName]) ? DATA.char_attr[charName] : {};
    const values = (DATA.char_values && DATA.char_values[charName]) ? DATA.char_values[charName] : [];

    const row = document.createElement('div'); row.className = 'char-row';
    const left = document.createElement('div');
    const right = document.createElement('div');

    left.innerHTML = `<div><strong>${charName}</strong>
      ${ item.case ? '<span class="rulepill">Case: '+item.case+'</span>' : '' }
      ${ item.prefix ? '<span class="rulepill">Prefix: '+item.prefix+'</span>' : '' }
      ${ item.suffix ? '<span class="rulepill">Suffix: '+item.suffix+'</span>' : '' }
      ${ (item.without_space||item.withoutSpace)==='Y' ? '<span class="rulepill">No Space</span>' : '' }
      ${ attr.entry_required ? '<span class="badge">Required</span>' : '' }
      ${ attr.additional_values ? '<span class="badge">Free text allowed</span>' : '' }
      </div>
      <div class="desc">${desc || '&nbsp;'} </div>`;

    const input = document.createElement('input');
    input.className = 'input';
    input.placeholder = "Isi nilai karakteristik…";
    input.dataset.charName = charName;
    input.dataset.sequence = String(item.sequence || 0);
    input.dataset.caseFlag = item.case || '';
    input.dataset.prefix = item.prefix || '';
    input.dataset.suffix = item.suffix || '';
    input.dataset.withoutSpace = item.without_space || item.withoutSpace || '';

    // datalist values
    if (values && values.length) {
      const listId = 'dl_'+charName;
      const dl = document.createElement('datalist');
      dl.id = listId;
      for (const v of values) {
        const o = document.createElement('option');
        o.value = v.value;
        dl.appendChild(o);
        if (v.default && !input.value) input.value = v.value;
      }
      input.setAttribute('list', listId);
      right.appendChild(dl);
    }
    right.appendChild(input);

    row.appendChild(left); row.appendChild(right);
    box.appendChild(row);
  }
}

function generateSummary() {
  const clsName = document.getElementById('classInput').value.trim();
  const server = document.getElementById('server').value.trim();
  const mid = document.getElementById('mid').value.trim();
  const company = document.getElementById('company').value.trim();

  const inputs = Array.from(document.querySelectorAll('#charBox input'));
  const parts = [];
  inputs.sort((a,b)=> parseInt(a.dataset.sequence||'0') - parseInt(b.dataset.sequence||'0'));
  for (const el of inputs) {
    let val = el.value.trim();
    if (!val) continue;
    // apply case
    val = applyCase(val, el.dataset.caseFlag);
    // prefix/suffix
    const pre = el.dataset.prefix || ''; const suf = el.dataset.suffix || '';
    val = (pre ? pre : '') + val + (suf ? suf : '');
    // spacing
    const noSpace = (el.dataset.withoutSpace||'').toUpperCase() === 'Y';
    if (parts.length === 0) {
      parts.push(val);
    } else {
      if (noSpace) {
        // merge to previous part without space
        parts[parts.length-1] = parts[parts.length-1] + val;
      } else {
        parts.push(val);
      }
    }
  }
  const matDesc = parts.join(' ');

  document.getElementById('sumServer').innerText = server || '-';
  document.getElementById('sumMID').innerText = mid || '-';
  document.getElementById('sumCompany').innerText = company || '-';
  document.getElementById('sumMatDesc').innerText = matDesc || '-';

  return { clsName, server, mid, company, matDesc, values: inputs.map(el => ({name: el.dataset.charName, val: el.value.trim()})) };
}

async function submitPayload() {
  const payload = generateSummary();
  if (!payload.clsName) { alert('Pilih Class yang tersedia (TABLE 1)'); return; }
  if (!DATA.classes[payload.clsName]) { alert('Class tidak terdaftar dalam TABLE 1.'); return; }
  try {
    await fetch(SUBMIT_URL, {
      method: 'POST',
      mode: 'no-cors',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify(Object.assign({ className: payload.clsName }, payload))
    });
    alert('Data dikirim ke Google Sheet (receiver).');
  } catch(e) {
    console.warn('Submit error:', e);
    alert('Gagal mengirim. Coba lagi.');
  }
}

document.addEventListener('DOMContentLoaded', async () => {
  try {
    await loadData();
    populateClassList();
    document.getElementById('classInput').addEventListener('change', (e)=> {
      const v = e.target.value.trim();
      if (!DATA.classes[v]) {
        e.target.value = '';
        document.getElementById('classMeta').innerText = 'Class tidak tersedia (hanya TABLE 1).';
        document.getElementById('charBox').innerHTML = '';
        return;
      } else {
        document.getElementById('classMeta').innerText = '';
      }
      renderCharacteristicsForClass(v);
    });
    document.getElementById('btnGen').addEventListener('click', generateSummary);
    document.getElementById('btnSubmit').addEventListener('click', submitPayload);
  } catch(e) {
    console.error('Init error', e);
    alert('Gagal memuat konfigurasi.');
  }
});
</script>
</body>
</html>
