<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MDG Material Form (Live Extractor, Object Dependency)</title>
<style>
/* Simplified Fiori-like styling */
:root{--sap-bg:#f5f7f9;--sap-surface:#fff;--sap-primary:#0a6ed1;--sap-border:#d7dce2;--sap-text:#111;--sap-muted:#69707a}
*{box-sizing:border-box}body{margin:0;font-family:Segoe UI,Roboto,Arial,sans-serif;background:var(--sap-bg);color:var(--sap-text)}
.container{max-width:1200px;margin:20px auto;padding:20px;background:var(--sap-surface);border-radius:12px;border:1px solid var(--sap-border);box-shadow:0 2px 4px rgba(0,0,0,0.05)}
h1{margin:0 0 10px 0;font-size:1.5rem;font-weight:600}
.row{display:flex;flex-wrap:wrap;gap:20px;margin-bottom:20px}
.card{flex:1 1 300px;background:#fff;border:1px solid var(--sap-border);border-radius:10px;padding:15px}
.label{font-weight:600;font-size:0.875rem;margin-bottom:5px;display:block}
.input, select{width:100%;padding:10px;border:1px solid var(--sap-border);border-radius:8px;background:var(--sap-surface);font-size:0.875rem}
.btn{padding:10px 16px;background:var(--sap-primary);color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:0.875rem}
.btn:disabled{opacity:0.5;cursor:not-allowed}
.desc{font-size:0.75rem;color:var(--sap-muted);margin-top:2px}
.char-row{display:grid;grid-template-columns:200px 1fr;gap:12px;align-items:start;padding:8px 0;border-bottom:1px dashed var(--sap-border)}
.char-row:last-child{border-bottom:none}
.badge{background:#eef5ff;color:#094b9b;padding:2px 6px;font-size:0.7rem;border-radius:999px;margin-left:4px}
.pill{background:#f1f5fb;border:1px solid #d7e3f8;color:#334;padding:2px 6px;font-size:0.7rem;border-radius:999px;margin-left:4px}
.summary-table{display:grid;grid-template-columns:200px 1fr;gap:8px;font-size:0.875rem}
.hidden{display:none !important}
</style>
</head>
<body>
<div class="container">
  <h1>MDG Material Form</h1>

  <!-- Info -->
  <div class="desc">Data will be fetched from live extractor and rendered dynamically. Object dependencies are applied.</div>

  <!-- Class and company selection -->
  <div class="row">
    <!-- Class selection -->
    <div class="card" style="max-width:400px">
      <label class="label" for="classInput">Class</label>
      <input id="classInput" class="input" list="classList" placeholder="Search class…"/>
      <datalist id="classList"></datalist>
      <div id="classInfo" class="desc"></div>
    </div>
    <!-- Company selection -->
    <div class="card" style="max-width:400px">
      <label class="label" for="companySelect">Use for Company</label>
      <select id="companySelect" class="input">
        <option value="">Select company…</option>
        <option>PT Sayap Mas Utama</option>
        <option>PT Wings Surya</option>
        <option>PT Karunia Alam Segar</option>
        <option>PT Prakarsa Alam Segar</option>
        <option>PT Tirta Alam Segar</option>
        <!-- Add the rest of your companies here or dynamically -->
      </select>
    </div>
    <!-- Server source -->
    <div class="card" style="max-width:300px">
      <label class="label" for="serverSource">Server Source</label>
      <input id="serverSource" class="input" placeholder="e.g. SPR"/>
    </div>
  </div>

  <!-- Characteristics container -->
  <div class="card" id="charCard">
    <div class="label">Characteristics</div>
    <div id="charContainer"></div>
  </div>

  <!-- Buttons -->
  <div class="row">
    <button id="genBtn" class="btn">Generate Summary</button>
    <button id="submitBtn" class="btn">Submit</button>
  </div>

  <!-- Summary output -->
  <div class="card">
    <div class="label">Summary</div>
    <div class="summary-table">
      <div>Server Source:</div><div id="sumServer">-</div>
      <div>CR/MID:</div><div id="sumCrMid">-</div>
      <div>Company:</div><div id="sumCompany">-</div>
      <div>Material Description:</div><div id="sumMatDesc">-</div>
    </div>
  </div>
</div>

<script>
// Configuration: new extractor URL and receiver
const DATA_URL = "https://script.google.com/macros/s/AKfycbzCIxDB_YpbhGWDft3ZcFvKtBfCgLEarXhf3Sc37x4sZqdzDhcdAHeV22lSiPc4PLmQ/exec";
const SUBMIT_URL = "https://script.google.com/macros/s/AKfycbzbLZUtvSxjBKOkpEOYgrxoDfXkg1H2K5ug-DTIKGpUH29RgM5-JIhedHqukAPpmWsr/exec";

// Object dependency mapping (trigger char -> {value: {dependent: mandatoryFlag}})
const DEPS = {
  'EMBOSSED_BRAND_WINGS': {
    'YES': { 'BRAND_WING': true }
  },
  'EXTERNAL_BRAND': {
    'YES': { 'NO_SERI_BRAND_EXTERNAL_PI': false, 'BRAND_EXTERNAL_PI': true }
  },
  'HAS_SPESIFIC_COLOUR': {
    'YES': { 'COLOUR': true }
  },
  'SPEC_QTY_IN_ONE_BUNDLE': {
    'YES': { 'QTY_IN_ONE_BUNDLE': true }
  },
  'ITEM_SHAPE': {
    'PERSEGI': { 'WIGTH_PCS_PI': true, 'SIZE_UNIT_DIMENSI': true },
    'BULAT': { 'DIAMETER_PCS_PI': true }
  }
};

// Data holder after fetch
let CONFIG = null;

// Utility: apply case conversion
function applyCase(value, flag) {
  if (!value) return value;
  flag = (flag || '').toUpperCase();
  if (flag === 'U') return value.toUpperCase();
  if (flag === 'L') return value.toLowerCase();
  if (flag === 'P') return value.replace(/\w\S*/g, w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase());
  return value;
}

// Fetch config from extractor (as JSON, no callback)
async function loadData() {
  const res = await fetch(DATA_URL);
  const data = await res.json();
  CONFIG = data;
  populateClassList();
}

function populateClassList() {
  const list = document.getElementById('classList');
  list.innerHTML = '';
  const classes = Object.keys(CONFIG.classes || {});
  classes.sort().forEach(cls => {
    const opt = document.createElement('option');
    opt.value = cls;
    list.appendChild(opt);
  });
}

function renderCharacteristics(cls) {
  const cont = document.getElementById('charContainer');
  cont.innerHTML = '';
  const rows = CONFIG.classes?.[cls] || [];
  rows.sort((a,b) => (a.sequence||0) - (b.sequence||0));
  rows.forEach(item => {
    const charName = item.characteristic || item.char_name || '';
    const row = document.createElement('div');
    row.className = 'char-row';
    row.dataset.charName = charName;

    const left = document.createElement('div');
    const title = document.createElement('div');
    title.innerHTML = `<strong>${charName}</strong>`;
    if (item.case) title.innerHTML += `<span class="pill">Case: ${item.case}</span>`;
    if (item.prefix) title.innerHTML += `<span class="pill">Prefix: ${item.prefix}</span>`;
    if (item.suffix) title.innerHTML += `<span class="pill">Suffix: ${item.suffix}</span>`;
    if ((item.without_space||'').toUpperCase() === 'Y') title.innerHTML += `<span class="pill">No Space</span>`;
    const attr = CONFIG.char_attr?.[charName] || {};
    if (attr.entry_required) title.innerHTML += `<span class="badge">Required</span>`;
    left.appendChild(title);
    const desc = document.createElement('div');
    desc.className = 'desc';
    desc.textContent = CONFIG.char_desc?.[charName] || '';
    left.appendChild(desc);

    const right = document.createElement('div');
    const input = document.createElement('input');
    input.className = 'input';
    input.placeholder = 'Enter value…';
    input.dataset.sequence = item.sequence || 0;
    input.dataset.charName = charName;
    input.dataset.case = item.case || '';
    input.dataset.prefix = item.prefix || '';
    input.dataset.suffix = item.suffix || '';
    input.dataset.withoutSpace = item.without_space || '';
    if (attr.entry_required) input.required = true;
    const allowed = CONFIG.char_values?.[charName] || [];
    if (allowed.length) {
      const dlId = 'dl_' + charName;
      const dl = document.createElement('datalist');
      dl.id = dlId;
      allowed.forEach(obj => {
        const opt = document.createElement('option');
        opt.value = obj.value;
        dl.appendChild(opt);
        if (obj.default && !input.value) input.value = obj.value;
      });
      input.setAttribute('list', dlId);
      right.appendChild(dl);
    }
    right.appendChild(input);

    row.appendChild(left);
    row.appendChild(right);
    cont.appendChild(row);
  });
  evaluateDependencies();
  document.querySelectorAll('#charContainer input').forEach(inp => {
    inp.addEventListener('change', evaluateDependencies);
  });
}

function evaluateDependencies() {
  document.querySelectorAll('#charContainer .char-row').forEach(row => {
    const charName = row.dataset.charName;
    let isDep = false;
    for (const key in DEPS) {
      for (const val in DEPS[key]) {
        if (DEPS[key][val][charName] !== undefined) { isDep = true; break; }
      }
      if (isDep) break;
    }
    if (isDep) row.classList.add('hidden'); else row.classList.remove('hidden');
    const input = row.querySelector('input');
    if (input) input.required = CONFIG.char_attr?.[charName]?.entry_required || false;
  });
  document.querySelectorAll('#charContainer input').forEach(inp => {
    const trigName = inp.dataset.charName;
    const val = inp.value.trim();
    if (DEPS[trigName] && DEPS[trigName][val]) {
      const deps = DEPS[trigName][val];
      Object.keys(deps).forEach(depChar => {
        const row = document.querySelector(`#charContainer .char-row[data-char-name="${depChar}"]`);
        if (row) {
          row.classList.remove('hidden');
          const mandatory = deps[depChar];
          const inputDep = row.querySelector('input');
          if (inputDep) inputDep.required = mandatory;
        }
      });
    }
  });
}

function buildMaterialDescription() {
  const parts = [];
  const inputs = Array.from(document.querySelectorAll('#charContainer input'));
  inputs.sort((a,b) => parseInt(a.dataset.sequence||'0') - parseInt(b.dataset.sequence||'0'));
  inputs.forEach(inp => {
    const valRaw = inp.value.trim();
    if (!valRaw) return;
    let val = applyCase(valRaw, inp.dataset.case);
    val = (inp.dataset.prefix || '') + val + (inp.dataset.suffix || '');
    const noSpace = (inp.dataset.withoutSpace || '').toUpperCase() === 'Y';
    if (parts.length === 0) parts.push(val);
    else if (noSpace) parts[parts.length-1] = parts[parts.length-1] + val;
    else parts.push(val);
  });
  return parts.join(' ');
}

function generateSummary() {
  const server = document.getElementById('serverSource').value.trim();
  const company = document.getElementById('companySelect').value.trim();
  const matDesc = buildMaterialDescription();
  let crmid = '';
  if (server.toUpperCase() === 'SPR') {
    crmid = prompt('Server = SPR. Input CR Number (max 8 characters)', '') || '';
    crmid = crmid.slice(0,8);
  } else {
    crmid = prompt('Input MID formed in ECC (max 8 digits)', '') || '';
    crmid = crmid.replace(/\D+/g, '').slice(0,8);
  }
  document.getElementById('sumServer').textContent = server || '-';
  document.getElementById('sumCrMid').textContent = crmid || '-';
  document.getElementById('sumCompany').textContent = company || '-';
  document.getElementById('sumMatDesc').textContent = matDesc || '-';
  return { server_source: server, crmid: crmid, company_use_for: company, mat_desc_to_be: matDesc };
}

async function submitForm() {
  const summary = generateSummary();
  const cls = document.getElementById('classInput').value.trim();
  const lines = [];
  document.querySelectorAll('#charContainer input').forEach(inp => {
    lines.push({ char_name: inp.dataset.charName, value: inp.value.trim() });
  });
  const payload = Object.assign({ class: cls, values: lines }, summary);
  try {
    await fetch(SUBMIT_URL, {
      method: 'POST',
      mode: 'no-cors',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify(payload)
    });
    alert('Form submitted successfully.');
  } catch (err) {
    console.error('Submit error:', err);
    alert('Submit failed.');
  }
}

// Event listeners
document.addEventListener('DOMContentLoaded', () => {
  loadData().catch(err => console.error('Data load error', err));
  document.getElementById('classInput').addEventListener('change', e => {
    const cls = e.target.value.trim();
    if (!CONFIG.classes?.[cls]) {
      document.getElementById('classInfo').textContent = 'Class not found in dataset.';
      document.getElementById('charContainer').innerHTML = '';
    } else {
      document.getElementById('classInfo').textContent = '';
      renderCharacteristics(cls);
    }
  });
  document.getElementById('genBtn').addEventListener('click', generateSummary);
  document.getElementById('submitBtn').addEventListener('click', submitForm);
});
</script>
</body>
</html>
